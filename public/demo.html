<!DOCTYPE html>
<html>
  <head>
    <title>Coimbatore Store Inventory</title>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <style>
      #map {
        height: 100%;
      }
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
      }
      #sidebar {
        position: absolute;
        width: 350px;
        height: 100%;
        background: white;
        box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        overflow-y: auto;
        padding: 15px;
        z-index: 10;
      }
      .tab {
        display: flex;
        margin-bottom: 15px;
      }
      .tab button {
        flex: 1;
        padding: 10px;
        background: #f1f1f1;
        border: none;
        cursor: pointer;
      }
      .tab button.active {
        background: #4CAF50;
        color: white;
      }
      .form-group {
        margin-bottom: 15px;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }
      input, select, button {
        width: 100%;
        padding: 8px;
        box-sizing: border-box;
        margin-bottom: 5px;
      }
      button {
        background: #4CAF50;
        color: white;
        border: none;
        padding: 10px;
        cursor: pointer;
      }
      button:hover {
        background: #45a049;
      }
      .store-item {
        padding: 10px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
      }
      .store-item:hover {
        background: #f5f5f5;
      }
      .inventory-item {
        display: flex;
        justify-content: space-between;
        padding: 3px 0;
      }
      #inventory-items {
        margin-top: 10px;
      }
      .inventory-row {
        display: flex;
        gap: 10px;
        margin-bottom: 5px;
      }
      .inventory-row input {
        flex: 2;
      }
      .inventory-row input:last-child {
        flex: 1;
      }
      .remove-btn {
        width: auto;
        background: #f44336;
        padding: 5px 10px;
      }
    </style>
  </head>
  <body>
    <div id="sidebar">
      <div class="tab">
        <button class="tab-btn active" onclick="openTab('view-tab')">View Stores</button>
        <button class="tab-btn" onclick="openTab('add-tab')">Add Your Store</button>
      </div>
      
      <div id="view-tab" class="tab-content">
        <h2>Coimbatore Stores</h2>
        <input type="text" id="search" placeholder="Search stores or items...">
        <div id="store-list">
          <!-- Stores will be added here dynamically -->
        </div>
      </div>
      
      <div id="add-tab" class="tab-content" style="display:none">
        <h2>Add Your Store</h2>
        <div class="form-group">
          <label for="store-name">Store Name</label>
          <input type="text" id="store-name" placeholder="Enter store name">
        </div>
        
        <div class="form-group">
          <label>Store Location</label>
          <button onclick="locateStore()">Pin Your Location on Map</button>
          <div id="location-status">Click the button and then click on the map</div>
          <input type="hidden" id="store-lat">
          <input type="hidden" id="store-lng">
        </div>
        
        <div class="form-group">
          <label>Inventory Items</label>
          <div id="inventory-items">
            <div class="inventory-row">
              <input type="text" placeholder="Item name" class="item-name">
              <input type="number" placeholder="Quantity" class="item-qty" min="0">
              <button class="remove-btn" onclick="removeInventoryRow(this)">×</button>
            </div>
          </div>
          <button onclick="addInventoryRow()">+ Add Item</button>
        </div>
        
        <button onclick="addStore()">Submit Store</button>
      </div>
    </div>
    
    <div id="map"></div>
    <script src="mapsJavaScriptAPI.js" async defer></script>
    <script>
      var map;
      var markers = [];
      var infoWindows = [];
      var coimbatoreCenter = {lat: 11.0168, lng: 76.9558};
      var stores = JSON.parse(localStorage.getItem('stores')) || [];
      var isAddingLocation = false;
      var tempMarker = null;

      function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          center: coimbatoreCenter,
          zoom: 13
        });
        
        // Add click listener for adding locations
        map.addListener('click', function(e) {
          if (isAddingLocation) {
            setStoreLocation(e.latLng.lat(), e.latLng.lng());
          }
        });
        
        // Load existing stores
        addStoresToMap();
        
        // Setup search functionality
        document.getElementById('search').addEventListener('input', function(e) {
          filterStores(e.target.value.toLowerCase());
        });
      }
      
      function openTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(tab => {
          tab.style.display = 'none';
        });
        document.querySelectorAll('.tab-btn').forEach(btn => {
          btn.classList.remove('active');
        });
        document.getElementById(tabId).style.display = 'block';
        event.currentTarget.classList.add('active');
      }
      
      function locateStore() {
        isAddingLocation = true;
        document.getElementById('location-status').textContent = 'Now click on the map to set your location';
        if (tempMarker) tempMarker.setMap(null);
      }
      
      function setStoreLocation(lat, lng) {
        isAddingLocation = false;
        document.getElementById('store-lat').value = lat;
        document.getElementById('store-lng').value = lng;
        document.getElementById('location-status').textContent = `Location set: ${lat.toFixed(4)}, ${lng.toFixed(4)}`;
        
        if (tempMarker) tempMarker.setMap(null);
        tempMarker = new google.maps.Marker({
          position: {lat: lat, lng: lng},
          map: map,
          icon: {
            url: "http://maps.google.com/mapfiles/ms/icons/green-dot.png",
            scaledSize: new google.maps.Size(32, 32)
          }
        });
        
        map.panTo({lat: lat, lng: lng});
        map.setZoom(16);
      }
      
      function addInventoryRow() {
        const container = document.getElementById('inventory-items');
        const row = document.createElement('div');
        row.className = 'inventory-row';
        row.innerHTML = `
          <input type="text" placeholder="Item name" class="item-name">
          <input type="number" placeholder="Quantity" class="item-qty" min="0">
          <button class="remove-btn" onclick="removeInventoryRow(this)">×</button>
        `;
        container.appendChild(row);
      }
      
      function removeInventoryRow(btn) {
        btn.parentElement.remove();
      }
      
      function addStore() {
        const name = document.getElementById('store-name').value;
        const lat = parseFloat(document.getElementById('store-lat').value);
        const lng = parseFloat(document.getElementById('store-lng').value);
        
        if (!name || !lat || !lng) {
          alert('Please fill all required fields');
          return;
        }
        
        // Collect inventory items
        const inventory = {};
        document.querySelectorAll('.inventory-row').forEach(row => {
          const itemName = row.querySelector('.item-name').value;
          const itemQty = parseInt(row.querySelector('.item-qty').value);
          if (itemName && !isNaN(itemQty)) {
            inventory[itemName] = itemQty;
          }
        });
        
        if (Object.keys(inventory).length === 0) {
          alert('Please add at least one inventory item');
          return;
        }
        
        // Create new store
        const newStore = {
          id: Date.now(),
          name: name,
          location: {lat: lat, lng: lng},
          inventory: inventory
        };
        
        // Add to stores array
        stores.push(newStore);
        localStorage.setItem('stores', JSON.stringify(stores));
        
        // Reset form
        document.getElementById('store-name').value = '';
        document.getElementById('store-lat').value = '';
        document.getElementById('store-lng').value = '';
        document.getElementById('location-status').textContent = 'Click the button and then click on the map';
        document.getElementById('inventory-items').innerHTML = `
          <div class="inventory-row">
            <input type="text" placeholder="Item name" class="item-name">
            <input type="number" placeholder="Quantity" class="item-qty" min="0">
            <button class="remove-btn" onclick="removeInventoryRow(this)">×</button>
          </div>
        `;
        if (tempMarker) tempMarker.setMap(null);
        
        // Add to map and switch to view tab
        addStoreToMap(newStore);
        openTab('view-tab');
        alert('Store added successfully!');
      }
      
      function addStoresToMap() {
        stores.forEach(store => {
          addStoreToMap(store);
        });
      }
      
      function addStoreToMap(store) {
        // Create marker
        const marker = new google.maps.Marker({
          position: store.location,
          map: map,
          title: store.name,
          icon: {
            url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png",
            scaledSize: new google.maps.Size(32, 32)
          }
        });
        
        // Create info window
        const infoWindow = new google.maps.InfoWindow({
          content: `
            <div style="min-width:200px">
              <h3 style="margin:5px 0">${store.name}</h3>
              <h4 style="margin:5px 0">Inventory:</h4>
              <div style="max-height:200px;overflow-y:auto">
                ${Object.entries(store.inventory).map(([item, quantity]) => `
                  <div style="display:flex;justify-content:space-between;padding:3px 0;border-bottom:1px solid #eee">
                    <span>${item}</span>
                    <span style="font-weight:bold">${quantity}</span>
                  </div>
                `).join('')}
              </div>
            </div>
          `
        });
        
        // Add click listener
        marker.addListener('click', () => {
          infoWindows.forEach(iw => iw.close());
          infoWindow.open(map, marker);
        });
        
        // Add to store list
        const storeItem = document.createElement('div');
        storeItem.className = 'store-item';
        storeItem.innerHTML = `
          <div class="store-name">${store.name}</div>
          <div>
            ${Object.entries(store.inventory).map(([item, quantity]) => `
              <div class="inventory-item">
                <span>${item}</span>
                <span>${quantity}</span>
              </div>
            `).join('')}
          </div>
        `;
        
        storeItem.addEventListener('click', () => {
          map.panTo(store.location);
          map.setZoom(16);
          infoWindows.forEach(iw => iw.close());
          infoWindow.open(map, marker);
        });
        
        document.getElementById('store-list').appendChild(storeItem);
        
        // Store references
        markers.push(marker);
        infoWindows.push(infoWindow);
      }
      
      function filterStores(searchTerm) {
        const storeList = document.getElementById('store-list');
        storeList.innerHTML = '';
        
        markers.forEach((marker, index) => {
          const store = stores[index];
          const matches = store.name.toLowerCase().includes(searchTerm) || 
                         Object.keys(store.inventory).some(item => 
                           item.toLowerCase().includes(searchTerm));
          
          marker.setVisible(matches);
          
          if (matches || !searchTerm) {
            const storeItem = document.createElement('div');
            storeItem.className = 'store-item';
            storeItem.innerHTML = `
              <div class="store-name">${store.name}</div>
              <div>
                ${Object.entries(store.inventory)
                  .filter(([item, quantity]) => 
                    !searchTerm || item.toLowerCase().includes(searchTerm))
                  .map(([item, quantity]) => `
                    <div class="inventory-item">
                      <span>${item}</span>
                      <span>${quantity}</span>
                    </div>
                  `).join('')}
              </div>
            `;
            
            storeItem.addEventListener('click', () => {
              map.panTo(store.location);
              map.setZoom(16);
              infoWindows.forEach(iw => iw.close());
              infoWindows[index].open(map, marker);
            });
            
            storeList.appendChild(storeItem);
          }
        });
      }
    </script>
  </body>
</html>